---
title: "datamerge"
author: "Olga Chyzh"
date: "March 11, 2019"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,message = FALSE,warning = FALSE,fig.cap = "...")
```

Load libraries:
```{r}
rm(list=ls())
library(data.table)
library(tidyverse)
library(magrittr)
library(tools)

```

#Weather data:
```{r}
myfiles<-list.files("./Data/countryfiles/")

agg_stations<-function(countryfiles) {
d<-read.table(paste0("./Data/countryfiles/",countryfiles), header=TRUE)
return(d)
}

weatherdata<-do.call(rbind,lapply(myfiles,agg_stations))
weatherdata<-weatherdata[!is.na(weatherdata$ave_precip_mo) | !is.na(weatherdata$ave_mo_t),]

#Add country names:
mynames<-read.csv("./Data/countrynames.csv", header=TRUE,  quote="'")
mynames<-mynames %>% unite(countryname,c("COUNTRY","X","X.1","X.2","X.3","X.4","X.5","X.6"), sep="") %>% mutate(countryname=toTitleCase(tolower(countryname)))
mynames

weatherdata<- weatherdata %>% left_join(mynames,by=c("fips"="FIPS"))
weatherdata$countryname[weatherdata$countryname=="Unitedkingdom"]<-"United Kingdom"
weatherdata$countryname[weatherdata$countryname=="Unitedstates"]<-"United States of America"
weatherdata$countryname[weatherdata$countryname=="Saudiarabia"]<-"Saudi Arabia"


#write.csv(weatherdata, "weatherdata.csv", row.names=FALSE)


```


#Merge GTD data with drug data:
```{r}
gtd<-fread("Data/globalterrorismdb.csv")
gtd$gcountry<-NA
gtd$gcountry[gtd$INT_LOG==0]<-gtd$country[gtd$INT_LOG==0]
gtd$gcountry_txt[gtd$INT_LOG==0]<-gtd$country_txt[gtd$INT_LOG==0]
gtd$gname[gtd$gname=="Mujahedin Kompak"]<-"Mujahideen Kompak"
#gtd<-filter(gtd, gtd$INT_LOG!=-9)
#write.csv(gtd,"Data/gtd.csv", row.names=FALSE)
#aggreagte gtd
#gtdgroup<-aggregate(eventid~gname+iyear+imonth, data=gtd, FUN=length)
gtd<-gtd %>% filter(imonth!=0 & is.finite(imonth)) %>% group_by(gname, iyear, imonth, attacktype1_txt) %>% summarise(num_attacks=length(eventid)) %>% ungroup %>% spread(attacktype1_txt, num_attacks) %>% mutate(incident=1)

#BAAD merge
baad<- read_delim("Data/BAAD_1_Lethality_Data.tab", "\t", escape_double = FALSE, trim_ws = TRUE)
baad$group[baad$group=="Mujahideen KOMPAK"]<-"Mujahideen Kompak"
mydata<-left_join(baad,gtd,by=c("group"="gname"))
mydata<-mydata %>% filter(!is.na(incident))


#Start with a blank group-month-year dataset:
gr_dates<-mydata %>% select(group, imonth, iyear) 

gr_dates<- gr_dates %>% mutate(date=paste(imonth,"01",iyear, sep="/"))  %>% mutate(date=as.Date(date, "%m/%d/%Y")) %>% group_by(group) %>% summarise(first_moyr=min(date), last_moyr=max(date)) %>% ungroup 

mk_data<-function(gr_dates ) {
  gr_dates<-as.data.frame(gr_dates)
  group=gr_dates[1,1]
  st_date=as.Date(gr_dates[2,1])
  end_date=as.Date(gr_dates[3,1])
dates<-seq(st_date,end_date, by="month")
return(cbind.data.frame(group=group,date=dates))
}

#gr_dates <- as.list(as.data.frame(t(gr_dates)))
#gr_dates<-gr_dates[1]
#mk_data(gr_dates)

gr_dates <- as.list(as.data.frame(t(gr_dates)))
myframe<-do.call(rbind,lapply(gr_dates,mk_data))
myframe <- myframe %>% mutate(month=month(date), year=year(date))

mydata<-left_join(myframe, mydata, by=c("group"="group","month"="imonth", "year"="iyear")) 
mydata$incident[is.na(mydata$incident)]<-0

#Open drug data:
drugdata<-read.csv("drugdata.csv")

#merge
drugdata$narcotics<-1
mydata<-left_join(mydata,drugdata, by=c("group"="GTD.name"))
mydata$narcotics[is.na(mydata$narcotics)]<-0

mydata <- mydata %>% group_by(group) %>% fill(mastertccode3606,statespond,cowmastercountry,masterccode,fatalities19982005,OrgAge,ordsize,terrStrong,degree,ContainRelig,
        ContainEthno,LeftNoReligEthno,PureRelig,PureEthno,ReligEthno,ContainRelig2,ContainEthno2,Islam)

mydata$`Armed Assault`<-replace_na(mydata$`Armed Assault`, 0) 
mydata$Assassination<-replace_na(mydata$Assassination, 0) 
mydata$`Bombing/Explosion`<-replace_na(mydata$`Bombing/Explosion`, 0)
mydata$`Facility/Infrastructure Attack`<-replace_na(mydata$`Facility/Infrastructure Attack`, 0)
mydata$Hijacking<-replace_na(mydata$Hijacking, 0)
mydata$`Hostage Taking (Barricade Incident)`<-replace_na(mydata$`Hostage Taking (Barricade Incident)`, 0)
mydata$`Hostage Taking (Kidnapping)`<-replace_na(mydata$`Hostage Taking (Kidnapping)`, 0)
mydata$`Unarmed Assault`<-replace_na(mydata$`Unarmed Assault`, 0)
mydata$Unknown<-replace_na(mydata$Unknown, 0)

mydata<-mydata %>%  mutate(num_attacks=`Armed Assault`+Assassination+`Bombing/Explosion`+`Facility/Infrastructure Attack`+Hijacking+`Hostage Taking (Barricade Incident)` +`Hostage Taking (Kidnapping)`+`Unarmed Assault`+Unknown )


```

Merge with weather data:
```{r}
mydata<-left_join(mydata, weatherdata, by=c("cowmastercountry"="countryname", "month"="MONTH","year"="YEAR"))
```

drugdata<-read.csv("drugdata.csv")

#merge
drugdata$narcotics<-1
gtddrug<-merge(gtdgroup,drugdata, by.x="gname", by.y="GTD.name",all = TRUE)
gtddrug$narcotics[is.na(gtddrug$narcotics)]<-0

#subset
gtddrug2<-subset(gtddrug, select=c("gname","iyear","imonth","eventid","Network.Connections","Territory","Country","Drug1",
                                   "Plant1","Plant2","Harvest1","Harvest2","Harvest3","narcotics"))



#CINC merge
CINC<-read.csv("NMC_5_0.csv")
gtddrug4<-merge(gtddrug3,CINC, by.x=c("masterccode", "iyear"), by.y= c("ccode","year"))

##Polity data merge
polity<-read.csv("p4_v2017.csv")
gtddrug5<-merge(gtddrug4,polity, by.x=c("masterccode", "iyear"), by.y= c("ccode","year"))

gtddrug5$democracy
gtddrug5$democracy[gtddrug5$polity2>=7]<-1
gtddrug5$democracy[is.na(gtddrug5$democracy)]<-0

#Subset
drugdata2<-subset(gtddrug5, select = c("gname","iyear","imonth","eventid",
                                       "Country","democracy",
                                       "Network.Connections","Territory","statespond",
                                       "Drug1","Plant1","Plant2","Harvest1","Harvest2","Harvest3","narcotics" ))
names(drugdata2)[names(drugdata2) == 'eventid'] <- 'numattack'


#merge drug temp data
temp<-read.csv("idealdrugtemp.csv")
mydata<-merge(drugdata2,temp, by.x=c("iyear","Country"), by.y=c("year","cname") )

#write new csv file for merged data

write.csv(mydata, "drugsandterrorism.csv")
